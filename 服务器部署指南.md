# 🚀 服务器部署指南 - 宝塔面板

本指南将帮助你使用宝塔面板将 SEO 网站管理系统部署到你的服务器上。

---

## 📋 系统要求

### 服务器配置
- **CPU**: 2核以上
- **内存**: 4GB 以上推荐
- **硬盘**: 20GB 以上
- **操作系统**: Ubuntu 20.04 / CentOS 7.x / Debian 10+

### 软件要求
- **Node.js**: 18.x 或 20.x
- **PostgreSQL**: 14+
- **PM2**: 进程管理器
- **Nginx**: 反向代理（宝塔自带）

---

## 📦 第一步：安装宝塔面板

### 1.1 Ubuntu/Debian 系统

```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh
sudo bash install.sh ed8484bec
```

### 1.2 CentOS 系统

```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh
sh install.sh ed8484bec
```

### 1.3 登录宝塔面板

安装完成后，记录显示的：
- 面板地址：`http://你的服务器IP:8888`
- 用户名和密码

---

## 🔧 第二步：宝塔面板环境配置

### 2.1 安装软件栈

登录宝塔面板后，在「软件商店」安装以下组件：

#### 必装软件
1. **Nginx** 1.22+（极速安装）
2. **PostgreSQL** 14.x（编译安装）
3. **PM2 管理器** 4.x（一键安装）

#### 可选软件
- **phpMyAdmin** - 如果需要可视化管理数据库

### 2.2 安装 Node.js

进入「软件商店」→ 搜索「Node 版本管理器」

```bash
# 或者手动安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
node -v  # 应该显示 v20.x.x
```

### 2.3 安装 pnpm

```bash
npm install -g pnpm
pnpm -v  # 验证安装
```

---

## 💾 第三步：配置 PostgreSQL 数据库

### 3.1 创建数据库

在宝塔面板：「数据库」→「PostgreSQL」→「添加数据库」

- 数据库名：`seo_websites`
- 用户名：`seo_user`
- 密码：`设置强密码`（记录下来）
- 访问权限：`本地服务器`

### 3.2 验证数据库连接

```bash
sudo -u postgres psql
\l  # 列出所有数据库
\q  # 退出
```

---

## 📁 第四步：上传和部署项目代码

### 4.1 创建项目目录

在宝塔面板：「文件」→ 创建目录

```
/www/wwwroot/seo-websites/
```

### 4.2 上传代码

**方法一：使用 Git（推荐）**

```bash
cd /www/wwwroot/
git clone https://github.com/你的用户名/seo-websites-monorepo.git seo-websites
cd seo-websites
```

**方法二：手动上传**
- 在宝塔面板「文件」中，点击「上传」
- 将项目 ZIP 压缩包上传并解压

### 4.3 安装依赖

```bash
cd /www/wwwroot/seo-websites
pnpm install
```

---

## ⚙️ 第五步：配置环境变量

### 5.1 创建 `.env.local` 文件

```bash
cd /www/wwwroot/seo-websites
nano .env.local
```

### 5.2 配置内容

```env
# ========== 数据库配置 ==========
DATABASE_URL="postgresql://seo_user:你的数据库密码@localhost:5432/seo_websites?schema=public"

# ========== NextAuth 配置 ==========
NEXTAUTH_URL="https://你的域名.com"
NEXTAUTH_SECRET="生成一个随机32位字符串"

# 生成方法：openssl rand -base64 32

# ========== OpenAI API配置（可选，后台可配置）==========
OPENAI_API_KEY="sk-your-api-key-here"

# ========== 网站URL配置 ==========
# 管理后台
NEXT_PUBLIC_ADMIN_URL="https://admin.你的域名.com"

# 前台网站（如果部署）
NEXT_PUBLIC_WEBSITE_1_URL="https://website1.你的域名.com"
NEXT_PUBLIC_WEBSITE_2_URL="https://website2.你的域名.com"
NEXT_PUBLIC_WEBSITE_TG_URL="https://tg.你的域名.com"

# ========== 应用配置 ==========
NODE_ENV="production"
PORT=3100
```

**保存文件**：按 `Ctrl+O` → `Enter` → `Ctrl+X`

---

## 🗄️ 第六步：初始化数据库

### 6.1 运行数据库迁移

```bash
cd /www/wwwroot/seo-websites
pnpm db:migrate:deploy
```

### 6.2 创建管理员账号（可选）

```bash
pnpm db:seed
```

这会创建默认管理员账号：
- 邮箱：`admin@example.com`
- 密码：`admin123`（首次登录后请立即修改）

---

## 🏗️ 第七步：构建生产版本

### 7.1 构建所有应用

```bash
cd /www/wwwroot/seo-websites
pnpm build
```

这会构建：
- ✅ 管理后台（apps/admin）
- ✅ 所有前台网站（apps/website-*）

### 7.2 验证构建

```bash
ls apps/admin/.next  # 应该看到构建文件
ls apps/website-1/.next
```

---

## 🚀 第八步：使用 PM2 启动应用

### 8.1 创建 PM2 配置文件

```bash
cd /www/wwwroot/seo-websites
nano ecosystem.config.js
```

```javascript
module.exports = {
  apps: [
    {
      name: 'seo-admin',
      cwd: '/www/wwwroot/seo-websites/apps/admin',
      script: 'node_modules/next/dist/bin/next',
      args: 'start -p 3100',
      env: {
        NODE_ENV: 'production',
        PORT: 3100
      },
      instances: 1,
      exec_mode: 'cluster',
      watch: false,
      max_memory_restart: '500M',
      error_file: '/www/wwwlogs/seo-admin-error.log',
      out_file: '/www/wwwlogs/seo-admin-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
    },
    // 如果需要部署前台网站，添加更多配置
    {
      name: 'seo-website-1',
      cwd: '/www/wwwroot/seo-websites/apps/website-1',
      script: 'node_modules/next/dist/bin/next',
      args: 'start -p 3001',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      },
      instances: 1,
      exec_mode: 'cluster',
      watch: false,
      max_memory_restart: '500M',
    }
  ]
}
```

### 8.2 启动应用

```bash
cd /www/wwwroot/seo-websites
pm2 start ecosystem.config.js
pm2 save  # 保存PM2配置
pm2 startup  # 开机自启动
```

### 8.3 查看运行状态

```bash
pm2 list  # 查看所有进程
pm2 logs seo-admin  # 查看日志
pm2 monit  # 实时监控
```

---

## 🌐 第九步：配置 Nginx 反向代理

### 9.1 在宝塔面板添加网站

「网站」→「添加站点」

- 域名：`admin.你的域名.com`
- 根目录：`/www/wwwroot/seo-websites`（任意，实际通过代理）
- PHP版本：纯静态
- 创建

### 9.2 配置反向代理

点击网站「设置」→「反向代理」→「添加反向代理」

**管理后台代理配置：**
```
代理名称：seo-admin
目标URL：http://127.0.0.1:3100
发送域名：$host
内容替换：无
```

高级配置：
```nginx
#PROXY-START/
location / {
    proxy_pass http://127.0.0.1:3100;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Next.js 特殊配置
    proxy_http_version 1.1;
    proxy_cache_bypass $http_upgrade;
    proxy_redirect off;

    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
#PROXY-END/
```

### 9.3 配置 SSL 证书

在站点「设置」→「SSL」

- 选择「Let's Encrypt」
- 勾选你的域名
- 点击「申请」

---

## 🔒 第十步：安全加固

### 10.1 配置防火墙

在宝塔「安全」中：
- 开放：`80`（HTTP）、`443`（HTTPS）、`8888`（宝塔面板）
- 关闭：`3100`、`3001`、`5432`（仅内部访问）

### 10.2 修改默认密码

首次登录后台：
```
https://admin.你的域名.com
邮箱：admin@example.com
密码：admin123
```

**立即修改密码！**

### 10.3 配置 API Keys

登录后台 → 系统设置 → API 配置
- OpenAI API Key
- 其他第三方服务 Keys

---

## 🔄 第十一步：自动化部署脚本（可选）

### 11.1 创建部署脚本

```bash
nano /www/wwwroot/seo-websites/deploy.sh
```

```bash
#!/bin/bash

echo "========== 开始部署 =========="

# 1. 拉取最新代码
cd /www/wwwroot/seo-websites
git pull origin master

# 2. 安装依赖
pnpm install

# 3. 数据库迁移
pnpm db:migrate:deploy

# 4. 构建应用
pnpm build

# 5. 重启 PM2 服务
pm2 restart all

echo "========== 部署完成 =========="
pm2 list
```

```bash
chmod +x deploy.sh
```

### 11.2 使用部署脚本

```bash
cd /www/wwwroot/seo-websites
./deploy.sh
```

---

## 📊 第十二步：监控和维护

### 12.1 查看应用日志

```bash
pm2 logs seo-admin  # 实时日志
pm2 logs seo-admin --lines 100  # 最近100行
```

### 12.2 重启应用

```bash
pm2 restart seo-admin  # 重启管理后台
pm2 restart all  # 重启所有应用
```

### 12.3 监控资源使用

```bash
pm2 monit  # 实时监控CPU和内存
```

### 12.4 数据库备份

在宝塔面板「数据库」→「备份」
- 设置自动备份（每天凌晨）
- 保留7天备份

---

## ❓ 常见问题排查

### 问题1：PM2 进程启动失败

```bash
# 查看详细错误
pm2 logs seo-admin --lines 50

# 检查端口占用
netstat -tlnp | grep 3100

# 手动测试启动
cd apps/admin
npm run start
```

### 问题2：Nginx 502 Bad Gateway

```bash
# 检查 PM2 进程状态
pm2 list

# 重启应用
pm2 restart seo-admin

# 检查 Nginx 配置
nginx -t
```

### 问题3：数据库连接失败

```bash
# 测试数据库连接
psql -U seo_user -d seo_websites -h localhost

# 检查 PostgreSQL 状态
sudo systemctl status postgresql
```

### 问题4：构建失败

```bash
# 清除缓存重新构建
rm -rf apps/admin/.next
rm -rf node_modules
pnpm install
pnpm build
```

---

## 📝 维护检查清单

### 每日检查
- [ ] PM2 进程状态正常
- [ ] 服务器磁盘空间充足（>20%）
- [ ] 数据库备份成功

### 每周检查
- [ ] 查看错误日志
- [ ] 检查系统更新
- [ ] 测试网站访问速度

### 每月检查
- [ ] 更新依赖包（谨慎）
- [ ] 审查安全日志
- [ ] 优化数据库性能

---

## 🆘 获取帮助

### 官方文档
- Turborepo: https://turbo.build/repo/docs
- Next.js: https://nextjs.org/docs
- Prisma: https://www.prisma.io/docs

### 技术支持
- GitHub Issues: 提交bug和功能请求
- 宝塔论坛: https://www.bt.cn/bbs/

---

## 🎉 部署成功！

访问你的管理后台：`https://admin.你的域名.com`

开始管理你的 SEO 网站吧！

