# 🚀 服务器部署指南 - 宝塔面板

本指南将帮助你使用宝塔面板将 SEO 网站管理系统部署到你的服务器上。

系统提供**一键自动化部署脚本**，只需几个命令即可完成全部部署流程！

---

## 🎯 宝塔面板快速参考

**重要：这是 Node.js 应用（Next.js），但配置方式如下：**

| 操作 | 在哪里配置 | 说明 |
|------|----------|------|
| **添加域名** | 「网站」部分（PHP） | 选择"纯静态"类型 |
| **配置反向代理** | 网站设置 → 反向代理 | 代理到 Node.js 端口 |
| **管理应用** | 使用 **PM2**（命令行） | **不用**「Node.js 项目管理器」 |
| **申请 SSL** | 网站设置 → SSL | Let's Encrypt 免费证书 |
| **查看日志** | `pm2 logs` | 不在宝塔面板查看 |

**为什么这样配置？**
- 🎯 PM2 更适合生产环境（自动重启、负载均衡、日志管理）
- 🎯 宝塔的「网站」功能用于配置 Nginx（反向代理、SSL）
- 🎯 不使用宝塔的 Node.js 管理器（功能有限，不如 PM2 强大）

---

## 📋 系统要求

### 服务器配置
- **CPU**: 2核以上
- **内存**: 4GB 以上推荐
- **硬盘**: 20GB 以上
- **操作系统**: Ubuntu 20.04 / CentOS 7.x / Debian 10+

### 软件要求
- **Node.js**: 18.x 或 20.x
- **PostgreSQL**: 14+
- **PM2**: 进程管理器
- **Nginx**: 反向代理（宝塔自带）
- **pnpm**: 8.15.0+

---

## ⚡ 快速开始（推荐）

如果你想快速完成部署，可以使用我们的一键部署脚本：

```bash
cd /www/wwwroot/seo-websites-monorepo
sudo ./scripts/quick-setup.sh
```

该脚本会自动完成以下步骤：
1. ✅ 检查系统要求（Node.js, pnpm, PostgreSQL, PM2）
2. ✅ 修复 PostgreSQL 配置
3. ✅ 初始化数据库
4. ✅ 检查环境变量配置
5. ✅ 安装项目依赖
6. ✅ 初始化 Prisma
7. ✅ 运行数据库迁移
8. ✅ 创建默认管理员账号
9. ✅ **部署 15 个域名配置**
10. ✅ 构建生产版本
11. ✅ 启动 PM2 服务

⏱️ 预计耗时：5-15 分钟

---

## 📦 详细部署步骤

### 第一步：安装宝塔面板

#### 1.1 Ubuntu/Debian 系统

```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh
sudo bash install.sh ed8484bec
```

#### 1.2 CentOS 系统

```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh
sh install.sh ed8484bec
```

#### 1.3 登录宝塔面板

安装完成后，记录显示的：
- 面板地址：`http://你的服务器IP:8888`
- 用户名和密码

---

### 第二步：宝塔面板环境配置

#### 2.1 安装软件栈

登录宝塔面板后，在「软件商店」安装以下组件：

**必装软件**
1. **Nginx** 1.22+（极速安装）
2. **PostgreSQL** 14.x（编译安装）
3. **PM2 管理器** 4.x（一键安装）

#### 2.2 安装 Node.js

进入「软件商店」→ 搜索「Node 版本管理器」

```bash
# 或者手动安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
node -v  # 应该显示 v20.x.x
```

#### 2.3 安装 pnpm

```bash
npm install -g pnpm
pnpm -v  # 验证安装
```

---

### 第三步：克隆项目代码

#### 3.1 创建项目目录并克隆代码

```bash
cd /www/wwwroot/
git clone https://github.com/你的用户名/seo-websites-monorepo.git
cd seo-websites-monorepo
```

---

### 第四步：使用自动化脚本部署

我们提供了多个自动化脚本，简化部署流程：

#### 🎯 方式一：一键完整部署（推荐）

```bash
cd /www/wwwroot/seo-websites-monorepo
sudo ./scripts/quick-setup.sh
```

**该脚本会自动完成：**
- ✅ 检查并安装所需软件（Node.js, pnpm, PostgreSQL, PM2）
- ✅ 修复 PostgreSQL 配置
- ✅ 创建数据库和用户
- ✅ 配置环境变量
- ✅ 安装依赖（使用 npx pnpm 避免路径问题）
- ✅ 初始化 Prisma 客户端
- ✅ 运行数据库迁移
- ✅ 创建默认管理员账号
- ✅ 部署 15 个域名配置
- ✅ 构建生产版本
- ✅ 启动 PM2 服务

按照提示操作即可完成全部部署！脚本使用 `npx pnpm` 执行命令，无需担心 pnpm 路径问题。

#### 🔧 方式二：分步骤执行（精细控制）

如果你想更精细地控制部署流程，可以使用辅助脚本分步执行：

**步骤 1: 修复 PostgreSQL 配置**

```bash
sudo ./scripts/fix-postgresql.sh
```

该脚本会：
- 清理重复的日志配置
- 修复监听地址和端口设置
- 创建日志目录并设置权限
- 重启服务并验证连接

**步骤 2: 初始化数据库**

```bash
sudo ./scripts/init-database.sh
```

该脚本会：
- 创建数据库 `seo_websites`
- 创建用户 `seo_user`
- 授予所有必要权限
- 生成 `DATABASE_URL` 连接字符串
- 测试数据库连接

**步骤 3: 配置环境变量**

编辑 `.env.local` 文件（会在 init-database.sh 后提示你填写）：

```bash
nano .env.local
```

粘贴生成的 DATABASE_URL，并配置其他必要信息。

**步骤 4: 安装依赖和初始化**

```bash
pnpm install
cd packages/database
npx dotenv -e ../../.env.local -- npx prisma generate
npx dotenv -e ../../.env.local -- npx prisma db push
npx dotenv -e ../../.env.local -- npm run db:seed
cd ../..
```

**步骤 5: 部署域名配置**

```bash
./scripts/deploy-domains.sh
```

该脚本会自动添加所有 15 个域名到数据库：

**Website 1 (5个域名):**
- telegram1688.com ⭐ (主域名)
- telegram2688.com
- telegramcny28.com
- telegramrmb28.com
- telegramxzb.com

**Website 2 (5个域名):**
- telegramcnfw.com ⭐ (主域名)
- telegramfuwu.com
- telegramfwfw.com
- telegramxzfw.com
- telegramzhfw.com

**Website TG (5个域名):**
- telegramgzzh.com ⭐ (主域名)
- telegramhnzh.com
- telegramjiaoyu.com
- xztelegram.com
- zhxztelegram.com

**步骤 6: 构建应用**

```bash
pnpm build
```

**步骤 7: 启动 PM2 服务**

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

---

### 第五步：配置 Nginx 反向代理

**重要说明：**
- ✅ 应用通过 **PM2** 管理（不使用宝塔的 Node.js 项目管理器）
- ✅ 在宝塔的 **「网站」** 部分添加站点（用于配置 Nginx）
- ✅ 选择 **「纯静态」** 类型（实际是反向代理到 Node.js 应用）

#### 5.1 在宝塔面板添加网站

**步骤：**

1. **进入网站管理**
   - 登录宝塔面板
   - 左侧菜单 → 「网站」

2. **添加站点 - 管理后台**

   点击「添加站点」，填写以下信息：

   ```
   域名：admin.telegram1688.com
   根目录：/www/wwwroot/seo-websites-monorepo（任意，实际通过代理）
   FTP：不创建
   数据库：不创建
   PHP版本：纯静态
   ```

   点击「提交」创建站点

3. **添加站点 - Website 1（5个域名）**

   点击「添加站点」，一次性添加多个域名：

   ```
   域名：
   telegram1688.com
   telegram2688.com
   telegramcny28.com
   telegramrmb28.com
   telegramxzb.com

   根目录：/www/wwwroot/seo-websites-monorepo（任意）
   FTP：不创建
   数据库：不创建
   PHP版本：纯静态
   ```

4. **添加站点 - Website 2（5个域名）**

   同样方式添加：

   ```
   域名：
   telegramcnfw.com
   telegramfuwu.com
   telegramfwfw.com
   telegramxzfw.com
   telegramzhfw.com

   根目录：/www/wwwroot/seo-websites-monorepo
   PHP版本：纯静态
   ```

5. **添加站点 - Website TG（5个域名）**

   ```
   域名：
   telegramgzzh.com
   telegramhnzh.com
   telegramjiaoyu.com
   xztelegram.com
   zhxztelegram.com

   根目录：/www/wwwroot/seo-websites-monorepo
   PHP版本：纯静态
   ```

**提示：**
- 多个域名可以在一个站点中用换行分隔
- 根目录设置不重要，因为实际通过反向代理访问
- 不要在「Node.js 项目管理器」中添加，我们使用 PM2 管理

#### 5.2 配置反向代理

为每个站点配置反向代理到对应的 Node.js 应用端口。

**步骤：**

1. **配置管理后台代理（admin.telegram1688.com → 端口 3100）**

   找到 `admin.telegram1688.com` 站点，点击「设置」→「反向代理」→「添加反向代理」

   **基本配置：**
   ```
   代理名称：seo-admin
   目标URL：http://127.0.0.1:3100
   发送域名：$host
   ```

   **高级配置（可选，点击"配置文件"修改）：**
   ```nginx
   location / {
       proxy_pass http://127.0.0.1:3100;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_set_header REMOTE-HOST $remote_addr;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "upgrade";

       # Next.js 优化配置
       proxy_http_version 1.1;
       proxy_cache_bypass $http_upgrade;
       proxy_redirect off;

       # 超时设置
       proxy_connect_timeout 60s;
       proxy_send_timeout 60s;
       proxy_read_timeout 60s;
   }
   ```

   点击「提交」保存。

2. **配置 Website 1 代理（5个域名 → 端口 3001）**

   找到包含 `telegram1688.com` 等 5 个域名的站点，点击「设置」→「反向代理」→「添加反向代理」

   ```
   代理名称：website-1
   目标URL：http://127.0.0.1:3001
   发送域名：$host
   ```

   使用相同的高级配置（只修改端口为 3001）

3. **配置 Website 2 代理（5个域名 → 端口 3002）**

   找到包含 `telegramcnfw.com` 等 5 个域名的站点

   ```
   代理名称：website-2
   目标URL：http://127.0.0.1:3002
   发送域名：$host
   ```

4. **配置 Website TG 代理（5个域名 → 端口 3003）**

   找到包含 `telegramgzzh.com` 等 5 个域名的站点

   ```
   代理名称：website-tg
   目标URL：http://127.0.0.1:3003
   发送域名：$host
   ```

**端口映射总结：**
```
admin.telegram1688.com    → http://127.0.0.1:3100 (管理后台)
telegram1688.com (等5个)  → http://127.0.0.1:3001 (Website 1)
telegramcnfw.com (等5个)  → http://127.0.0.1:3002 (Website 2)
telegramgzzh.com (等5个)  → http://127.0.0.1:3003 (Website TG)
```

**验证配置：**

配置完成后，点击站点「设置」→「配置文件」，检查 Nginx 配置是否正确生成。

#### 5.3 配置 SSL 证书

在站点「设置」→「SSL」

- 选择「Let's Encrypt」
- 勾选你的域名
- 点击「申请」

**提示**：如果域名较多，可以使用通配符证书或为每个域名单独申请。

---

### 第六步：DNS 解析配置

在域名注册商（阿里云、腾讯云等）添加 A 记录：

```
类型：A
主机记录：@ 或 admin (管理后台)
记录值：你的服务器IP地址
TTL：600
```

为所有 15 个前台域名添加相同的解析记录。

---

## 🔄 日常维护和更新

### 自动化部署脚本

项目已包含自动化部署脚本 `deploy.sh`：

```bash
cd /www/wwwroot/seo-websites-monorepo
./deploy.sh
```

该脚本会自动：
1. 拉取最新代码
2. 安装依赖
3. 运行数据库迁移
4. 构建应用
5. 重启 PM2 服务

### 手动部署流程

```bash
cd /www/wwwroot/seo-websites-monorepo

# 1. 拉取最新代码
git pull origin master

# 2. 安装依赖
pnpm install

# 3. 数据库迁移
cd packages/database
npx dotenv -e ../../.env.local -- npx prisma db push
cd ../..

# 4. 构建应用
pnpm build

# 5. 重启服务
pm2 restart all
```

---

## 📊 监控和维护

### 查看应用状态

```bash
pm2 list  # 查看所有进程
pm2 logs seo-admin  # 查看日志
pm2 monit  # 实时监控
```

### 重启应用

```bash
pm2 restart seo-admin  # 重启管理后台
pm2 restart all  # 重启所有应用
```

### 数据库备份

在宝塔面板「数据库」→「备份」
- 设置自动备份（每天凌晨）
- 保留7天备份

---

## ❓ 常见问题排查

### 问题1：PostgreSQL 连接失败

```bash
# 运行修复脚本
sudo ./scripts/fix-postgresql.sh

# 手动检查
sudo systemctl status postgresql
psql -U seo_user -d seo_websites -h localhost
```

### 问题2：PM2 进程启动失败

```bash
# 查看详细错误
pm2 logs seo-admin --lines 50

# 检查端口占用
netstat -tlnp | grep 3100

# 手动测试启动
cd apps/admin
npm run start
```

### 问题3：Nginx 502 Bad Gateway

```bash
# 检查 PM2 进程状态
pm2 list

# 重启应用
pm2 restart seo-admin

# 检查 Nginx 配置
nginx -t
```

### 问题4：域名无法访问

1. 检查 DNS 解析是否生效（可能需要24小时）
2. 检查 Nginx 配置是否正确
3. 检查 PM2 服务是否运行
4. 检查防火墙端口是否开放（80, 443）

---

## 📝 自动化脚本详解

### 核心脚本

#### 1. quick-setup.sh - 一键部署脚本（主脚本）

**位置**：`scripts/quick-setup.sh`

**功能**：
- 🚀 一键完成从零到部署的全部 11 个步骤
- 🎯 交互式提示，让你选择跳过某些步骤
- 🎨 彩色输出，清晰展示进度
- ⚡ 使用 `npx pnpm` 执行命令，避免路径问题

**使用方法**：
```bash
cd /www/wwwroot/seo-websites-monorepo
sudo ./scripts/quick-setup.sh
```

#### 2. deploy.sh - 日常更新部署脚本

**位置**：`deploy.sh`（根目录）

**功能**：
- 拉取最新代码
- 安装依赖
- 运行数据库迁移
- 构建应用
- 重启 PM2 服务

**使用方法**：
```bash
./deploy.sh
```

**使用场景**：当你更新代码后需要重新部署时使用。

---

### 辅助脚本

#### 3. fix-postgresql.sh - PostgreSQL 修复脚本

**位置**：`scripts/fix-postgresql.sh`

**功能**：
- 清理重复的日志配置
- 修复监听地址和端口设置
- 创建日志目录并设置权限
- 重启服务并验证连接

**使用方法**：
```bash
sudo ./scripts/fix-postgresql.sh
```

**使用场景**：PostgreSQL 连接失败时使用。

#### 4. init-database.sh - 数据库初始化脚本

**位置**：`scripts/init-database.sh`

**功能**：
- 创建数据库 `seo_websites`
- 创建用户 `seo_user`
- 授予所有必要权限
- 生成 `DATABASE_URL` 连接字符串
- 测试数据库连接

**使用方法**：
```bash
sudo ./scripts/init-database.sh
```

**使用场景**：首次部署或重置数据库时使用。

#### 5. deploy-domains.sh - 域名配置部署脚本

**位置**：`scripts/deploy-domains.sh`

**功能**：
- 自动添加所有 15 个域名到数据库
- 配置域名别名、SEO 信息和标签
- 按网站自动分配域名（每个网站 5 个域名）

**使用方法**：
```bash
./scripts/deploy-domains.sh
```

**使用场景**：首次部署后添加域名配置，或更新域名配置时使用。

---

### 脚本关系图

```
quick-setup.sh (主脚本)
    ├── fix-postgresql.sh (自动调用)
    ├── init-database.sh (自动调用)
    └── deploy-domains.sh (自动调用)

deploy.sh (日常更新)
    └── 独立运行
```

**推荐使用流程**：
1. 首次部署：运行 `quick-setup.sh`
2. 日常更新：运行 `deploy.sh`
3. 问题修复：运行相应的辅助脚本

---

## 🔒 安全加固

### 配置防火墙

在宝塔「安全」中：
- ✅ 开放：`80`（HTTP）、`443`（HTTPS）、`8888`（宝塔面板）
- ❌ 关闭：`3100`、`3001`、`3002`、`3003`、`5432`（仅内部访问）

### 修改默认密码

首次登录后台：
```
https://admin.telegram1688.com
邮箱：admin@example.com
密码：admin123
```

**立即修改密码！**

### 配置 API Keys

登录后台 → 系统设置 → API 配置
- OpenAI API Key
- 其他第三方服务 Keys

---

## 📚 相关文档

- **域名配置指南**：`docs/域名配置指南.md` - 详细的 15 个域名配置说明
- **使用说明书**：`docs/使用说明书.md` - 系统功能使用手册
- **README.md**：项目概览和快速开始

---

## 🎉 部署成功！

访问你的管理后台：
```
https://admin.telegram1688.com
```

默认登录信息：
- 邮箱：`admin@example.com`
- 密码：`admin123`

**⚠️ 首次登录后请立即修改密码！**

现在你可以：
1. ✅ 登录管理后台
2. ✅ 查看已配置的 15 个域名
3. ✅ 开始添加文章内容
4. ✅ 配置 SEO 优化策略
5. ✅ 监控蜘蛛池访问情况
6. ✅ 追踪关键词排名

开始管理你的 SEO 网站吧！🚀
