# ============================================
# 服务器2 - Nginx跳转配置
# ============================================
#
# 用途：流量分发、访问过滤、SEO引导
#
# 安装位置：
# /etc/nginx/sites-available/redirect.conf
#
# 启用配置：
# ln -s /etc/nginx/sites-available/redirect.conf /etc/nginx/sites-enabled/
# nginx -t && nginx -s reload

# ============================================
# 上游服务器配置（服务器1的3个网站）
# ============================================
upstream website1_backend {
    server 服务器1_IP:3001;
    keepalive 32;
}

upstream website2_backend {
    server 服务器1_IP:3002;
    keepalive 32;
}

upstream websitetg_backend {
    server 服务器1_IP:3003;
    keepalive 32;
}

# ============================================
# 限流配置
# ============================================
limit_req_zone $binary_remote_addr zone=redirect_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ============================================
# GeoIP配置（可选）
# ============================================
# 需要安装 nginx-module-geoip
# geo $allowed_country {
#     default 0;
#     CN 1;  # 允许中国
#     US 1;  # 允许美国
#     # 添加更多国家...
# }

# ============================================
# User-Agent检测（搜索引擎识别）
# ============================================
map $http_user_agent $is_bot {
    default 0;
    ~*Googlebot 1;
    ~*Bingbot 1;
    ~*Baiduspider 1;
    ~*Yandex 1;
    ~*Slurp 1;
    ~*DuckDuckBot 1;
    ~*Sogou 1;
    ~*360Spider 1;
}

# ============================================
# 跳转路由服务器
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name jump.telegram1688.com redirect.telegram1688.com;

    # 日志
    access_log /var/log/nginx/redirect-access.log;
    error_log /var/log/nginx/redirect-error.log;

    # 限流
    limit_req zone=redirect_limit burst=20 nodelay;
    limit_conn conn_limit 10;

    # ==========================================
    # Link跳转路由
    # ==========================================

    # 跳转到网站1
    location /go/telegram1 {
        return 302 https://telegram1688.com;
    }

    location /go/download1 {
        return 302 https://telegram1688.com/download;
    }

    # 跳转到网站2
    location /go/telegram2 {
        return 302 https://telegramjiaoyu.com;
    }

    location /go/download2 {
        return 302 https://telegramjiaoyu.com/download;
    }

    # 跳转到网站TG
    location /go/telegramtg {
        return 302 https://telegramzhfw.com;
    }

    location /go/downloadtg {
        return 302 https://telegramzhfw.com/download;
    }

    # 通用跳转（带参数）
    location ~ ^/go/([a-z0-9]+)$ {
        set $target "";

        # 使用map或if判断跳转目标
        if ($1 = "tg1") {
            set $target "https://telegram1688.com";
        }
        if ($1 = "tg2") {
            set $target "https://telegramjiaoyu.com";
        }
        if ($1 = "tgtg") {
            set $target "https://telegramzhfw.com";
        }

        if ($target = "") {
            return 404;
        }

        return 302 $target;
    }

    # ==========================================
    # 默认行为：根据User-Agent分流
    # ==========================================
    location / {
        # 搜索引擎：代理到网站1（展示优化内容）
        if ($is_bot = 1) {
            proxy_pass http://website1_backend;
            break;
        }

        # 普通用户：跳转到主站
        return 302 https://telegram1688.com;
    }
}

# ============================================
# SEO引导服务器（针对搜索引擎优化的代理）
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name seo.telegram1688.com;

    access_log /var/log/nginx/seo-access.log;
    error_log /var/log/nginx/seo-error.log;

    # ==========================================
    # 只服务搜索引擎（其他访问返回403）
    # ==========================================
    location / {
        # 非搜索引擎，拒绝访问
        if ($is_bot = 0) {
            return 403;
        }

        # 搜索引擎：代理到网站1
        proxy_pass http://website1_backend;
        proxy_set_header Host telegram1688.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 缓存配置（为搜索引擎缓存内容）
        proxy_cache_bypass $http_pragma $http_authorization;
        proxy_no_cache $http_pragma $http_authorization;
        add_header X-Cache-Status $upstream_cache_status;
    }
}

# ============================================
# 访问过滤服务器（IP白名单）
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name admin-proxy.telegram1688.com;

    access_log /var/log/nginx/admin-proxy-access.log;
    error_log /var/log/nginx/admin-proxy-error.log;

    # ==========================================
    # IP白名单（只允许管理员访问）
    # ==========================================
    location / {
        # 允许的IP地址
        allow 1.2.3.4;        # 管理员IP
        allow 10.0.0.0/8;     # 内网IP段
        deny all;             # 拒绝其他所有

        # 代理到服务器3的管理后台
        proxy_pass http://服务器3_内网IP:3100;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 禁用缓存（管理后台需要实时数据）
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
}

# ============================================
# 隐藏真实结构的代理
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name t.telegram1688.com;

    access_log /var/log/nginx/hidden-access.log;
    error_log /var/log/nginx/hidden-error.log;

    # ==========================================
    # 隐藏后端真实URL
    # ==========================================
    location /channel/ {
        # 重写URL，隐藏真实路径
        rewrite ^/channel/(.*)$ /real-path/$1 break;

        proxy_pass http://website1_backend;
        proxy_set_header Host telegram1688.com;
        proxy_set_header X-Real-IP $remote_addr;

        # 隐藏响应头中的服务器信息
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;
        add_header Server "CloudFlare" always;
    }

    location /s/ {
        # 映射到实际的静态资源路径
        rewrite ^/s/(.*)$ /static/$1 break;
        proxy_pass http://website1_backend;
    }
}

# ============================================
# HTTPS配置示例（使用Let's Encrypt）
# ============================================
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name jump.telegram1688.com;
#
#     ssl_certificate /etc/letsencrypt/live/jump.telegram1688.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/jump.telegram1688.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#
#     # ... 其他配置同上 ...
# }
